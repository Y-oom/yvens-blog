<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="shortcut icon" href="/favicon.ico"> <title>[Java] java.lang.OutOfMemoryError - Out of Memory</title> <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet"> <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet"> <link rel="stylesheet" href="/assets/dist/css/style.css"> <!-- <link rel="stylesheet" href="/assets/dist/awsm.css/awsm_theme_big-stone.min.css" media="(prefers-color-scheme: dark)"> <link rel="stylesheet" href="/assets/dist/awsm.css/awsm_theme_white.min.css" media="(prefers-color-scheme: no-preference), (prefers-color-scheme: light)"> <link rel="stylesheet" href="/assets/dist/rouge/syntax-base16.dark.css" media="(prefers-color-scheme: dark)"> <link rel="stylesheet" href="/assets/dist/rouge/syntax-github.css" media="(prefers-color-scheme: no-preference), (prefers-color-scheme: light)"> --> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>[Java] java.lang.OutOfMemoryError | Out of Memory</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="[Java] java.lang.OutOfMemoryError" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="INDEX" /> <meta property="og:description" content="INDEX" /> <link rel="canonical" href="https://outofmemory.blog/outofmemoryerror-p8.html" /> <meta property="og:url" content="https://outofmemory.blog/outofmemoryerror-p8.html" /> <meta property="og:site_name" content="Out of Memory" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2018-03-08T00:00:00+08:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="[Java] java.lang.OutOfMemoryError" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2018-03-08T00:00:00+08:00","datePublished":"2018-03-08T00:00:00+08:00","description":"INDEX","headline":"[Java] java.lang.OutOfMemoryError","mainEntityOfPage":{"@type":"WebPage","@id":"https://outofmemory.blog/outofmemoryerror-p8.html"},"url":"https://outofmemory.blog/outofmemoryerror-p8.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <div class="content"> <header> <div class="main"> <a href="https://outofmemory.blog/">Out of Memory</a> </div> <nav> <a class='' href="/">首页</a> <!-- <a class='' href="/archives.html"> Archives</a> --> <a class='' href="/about.html">关于</a> </nav> </header> <hr class="light-hr"> <main> <div class="title"> <h1 class="title">[Java] java.lang.OutOfMemoryError</h1> <div class="meta"> <time datetime="08-03-2018">Mar 08 2018</time> </div> </div> <hr class="no-margin light-hr "> <blockquote> <p><a href="/outofmemoryerror">INDEX</a></p> </blockquote> <h2 id="javalangoutofmemoryerror-kill-process-or-sacrifice-child">java.lang.OutOfMemoryError: Kill process or sacrifice child</h2> <p>In order to understand this error, we need to recoup the operating system basics. As you know, operating systems are built on the concept of processes. Those processes are shepherded by several kernel jobs, one of which, named “Out of memory killer” is of interest to us in this particular case.</p> <p>This kernel job can annihilate your processes under extremely low memory conditions. When such a condition is detected, the Out of memory killer is activated and picks a process to kill. The target is picked using a set of heuristics scoring all processes and selecting the one with the worst score to kill. The <code class="language-plaintext highlighter-rouge">java.lang.OutOfMemoryError: Kill process or sacrifice child</code> is thus different from other errors covered in our OOM handbook as it is not triggered nor proxied by the JVM but is a safety net built into the operating system kernels.</p> <center> <img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/assets/dist/images/mhtja9ieb.pic.png" /> <br /> </center> <p>The <code class="language-plaintext highlighter-rouge">java.lang.OutOfMemoryError: kill process or sacrifice child</code> error is generated when the available virtual memory (including swap) is consumed to the extent where the overall operating system stability is put to risk. In such case the Out of memory killer picks the rogue process and kills it.</p> <h3 id="what-is-causing-it">What is causing it?</h3> <p>By default, Linux kernels allow processes to request more memory than currently available in the system. This makes all the sense in the world, considering that most of the processes never actually use all of the memory they allocate. The easiest comparison to this approach would be the broadband operators. They sell all the consumers a 100Mbit download promise, far exceeding the actual bandwidth present in their network. The bet is again on the fact that the users will not simultaneously all use their allocated download limit. Thus one 10Gbit link can successfully serve way more than the 100 users our simple math would permit.</p> <p>A side effect of such an approach is visible in case some of your programs are on the path of depleting the system’s memory. This can lead to extremely low memory conditions, where no pages can be allocated to process. You might have faced such situation, where not even a root account cannot kill the offending task. To prevent such situations, the killer activates, and identifies the rogue process to be the killed.</p> <p>You can read more about fine-tuning the behaviour of “Out of memory killer” in this article from <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/s-memory-captun.html" target="_blank">RedHat documentation</a>.</p> <p>Now that we have the context, how can you know what triggered the “killer” and woke you up at 5AM? One common trigger for the activation is hidden in the operating system configuration. When you check the configuration in <code class="language-plaintext highlighter-rouge">/proc/sys/vm/overcommit_memory</code>, you have the first hint – the value specified here indicates whether all <code class="language-plaintext highlighter-rouge">malloc()</code> calls are allowed to succeed. Note that the path to the parameter in the proc file system varies depending on the system affected by the change.</p> <p>Overcommitting configuration allows to allocate more and more memory for this rogue process which can eventually trigger the “Out of memory killer” to do exactly what it is meant to do.</p> <h3 id="give-me-an-example">Give me an example</h3> <p>When you compile and launch the following Java code snippet on Linux (I used the latest stable Ubuntu version):</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">eu.plumbr.demo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OOM</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">List</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">[]&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ArrayList</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">l</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">100_000_000</span><span class="o">]);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>then you will face an error similar to the following in the system logs (<code class="language-plaintext highlighter-rouge">/var/log/kern.log</code> in our example):</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Jun 4 07:41:59 plumbr kernel: 
	<span class="o">[</span>70667120.897649]
	Out of memory: Kill process 29957 <span class="o">(</span>java<span class="o">)</span> score 366 or sacrifice child
Jun 4 07:41:59 plumbr kernel: 
	<span class="o">[</span>70667120.897701]
	Killed process 29957 <span class="o">(</span>java<span class="o">)</span> total-vm:2532680kB, anon-rss:1416508kB, file-rss:0kB
</code></pre></div></div> <p>Note that you might need to tweak the swapfile and heap sizes, in our testcase we used a 2g heap specified by <code class="language-plaintext highlighter-rouge">-Xmx2g</code> and had the following swap configuration:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swapoff <span class="nt">-a</span> 
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>swapfile <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>655360
mkswap swapfile
swapon swapfile
</code></pre></div></div> <h3 id="what-is-the-solution">What is the solution?</h3> <p>There are several ways to handle such situation. The first and most straightforward way to overcome the issue is to migrate the system to an instance with more memory.</p> <p>Other possibilities would involve <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/s-memory-captun.html" target="_blank">fine-tuning the OOM killer</a>, scaling the load horizontally across several small instances or reducing the memory requirements of the application.</p> <p>One solution which we are not keen to recommend involves increasing swap space. When you recall that Java is a garbage collected language, then this solution already seems less lucrative. Modern GC algorithms are efficient when running in physical memory, but when dealing with swapped allocations the efficiency is hammered. Swapping can increase the length of GC pauses in several orders of magnitude, so you should think twice before jumping to this solution.</p> <div class="post-tags"> <nav class="nav-post-tags-list"> <ul class="tags"> <li><a href="/tag/java/">Java</a></li> <li><a href="/tag/oom/">OOM</a></li> <li><a href="/tag/jvm/">JVM</a></li> </ul> </nav> </div> </main> <footer> <hr class="footer-hr"> <div class="ui-flex"> <div class='wrapper-footer'> © 2025 Out of Memory.blog | <a href="mailto:yvens.fv@gmail.com">yvens</a> </div> </div> </footer> </div> </body> </html>
