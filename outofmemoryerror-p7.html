<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="shortcut icon" href="/favicon.ico"> <title>[Java] java.lang.OutOfMemoryError - Out of Memory</title> <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet"> <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet"> <link rel="stylesheet" href="/assets/dist/css/style.css"> <!-- <link rel="stylesheet" href="/assets/dist/awsm.css/awsm_theme_big-stone.min.css" media="(prefers-color-scheme: dark)"> <link rel="stylesheet" href="/assets/dist/awsm.css/awsm_theme_white.min.css" media="(prefers-color-scheme: no-preference), (prefers-color-scheme: light)"> <link rel="stylesheet" href="/assets/dist/rouge/syntax-base16.dark.css" media="(prefers-color-scheme: dark)"> <link rel="stylesheet" href="/assets/dist/rouge/syntax-github.css" media="(prefers-color-scheme: no-preference), (prefers-color-scheme: light)"> --> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>[Java] java.lang.OutOfMemoryError | Out of Memory</title> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="[Java] java.lang.OutOfMemoryError" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="INDEX" /> <meta property="og:description" content="INDEX" /> <link rel="canonical" href="https://outofmemory.blog/outofmemoryerror-p7.html" /> <meta property="og:url" content="https://outofmemory.blog/outofmemoryerror-p7.html" /> <meta property="og:site_name" content="Out of Memory" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2018-03-08T00:00:00+08:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="[Java] java.lang.OutOfMemoryError" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2018-03-08T00:00:00+08:00","datePublished":"2018-03-08T00:00:00+08:00","description":"INDEX","headline":"[Java] java.lang.OutOfMemoryError","mainEntityOfPage":{"@type":"WebPage","@id":"https://outofmemory.blog/outofmemoryerror-p7.html"},"url":"https://outofmemory.blog/outofmemoryerror-p7.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <div class="content"> <header> <div class="main"> <a href="https://outofmemory.blog/">Out of Memory</a> </div> <nav> <a class='' href="/">首页</a> <!-- <a class='' href="/archives.html"> Archives</a> --> <a class='' href="/about.html">关于</a> </nav> </header> <hr class="light-hr"> <main> <div class="title"> <h1 class="title">[Java] java.lang.OutOfMemoryError</h1> <div class="meta"> <time datetime="08-03-2018">Mar 08 2018</time> </div> </div> <hr class="no-margin light-hr "> <blockquote> <p><a href="/outofmemoryerror">INDEX</a></p> </blockquote> <h2 id="javalangoutofmemoryerror-requested-array-size-exceeds-vm-limit">java.lang.OutOfMemoryError: Requested array size exceeds VM limit</h2> <p>Java has got a limit on the maximum array size your program can allocate. The exact limit is platform-specific but is generally somewhere between 1 and 2.1 billion elements.</p> <center> <img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/assets/dist/images/j8hjg6q4k.pic.png" /> <br /> </center> <p>When you face the <code class="language-plaintext highlighter-rouge">java.lang.OutOfMemoryError: Requested array size exceeds VM limi</code>t, this means that the application that crashes with the error is trying to allocate an array larger than the Java Virtual Machine can support.</p> <h3 id="what-is-causing-it">What is causing it?</h3> <p>The error is thrown by the native code within the JVM. It happens before allocating memory for an array when the JVM performs a platform-specific check: whether the allocated data structure is addressable in this platform. This error is less common than you might initially think.</p> <p>The reason you only seldom face this error is that Java arrays are indexed by int. The maximum positive int in Java is 2^31 – 1 = 2,147,483,647. And the platform-specific limits can be really close to this number – for example on my 64bit MB Pro on Java 1.7 I can happily initialize arrays with up to <code class="language-plaintext highlighter-rouge">2,147,483,645</code> or <code class="language-plaintext highlighter-rouge">Integer.MAX_VALUE-2</code> elements.</p> <p>Increasing the length of the array by one to Integer.MAX_VALUE-1 results in the familiar OutOfMemoryError:</p> <p><code class="language-plaintext highlighter-rouge">Exception in thread "main" java.lang.OutOfMemoryError: Requested array size exceeds VM limit</code></p> <p>But the limit might not be that high – on 32-bit Linux with OpenJDK 6, you will hit the “java.lang.OutOfMemoryError: Requested array size exceeds VM limit” already when allocating an array with ~1.1 billion elements. To understand the limits of your specific environments run the small test program described in the next chapter.</p> <h3 id="give-me-an-example">Give me an example</h3> <p>When trying to recreate the java.lang.OutOfMemoryError: Requested array size exceeds VM limit error, let’s look at the following code:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="n">i</span><span class="o">];</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Successfully initialized an array with %,d elements.\n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="n">i</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">t</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>The example iterates four times and initializes an array of long primitives on each turn. The size of the array this program is trying to initialize grows by one with every iteration and finally reaches <code class="language-plaintext highlighter-rouge">Integer.MAX_VALUE</code>. Now, when launching the code snippet on 64-bit Mac OS X with Hotspot 7, you should get the output similar to the following:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java.lang.OutOfMemoryError: Java heap space
  at eu.plumbr.demo.ArraySize.main<span class="o">(</span>ArraySize.java:8<span class="o">)</span>
java.lang.OutOfMemoryError: Java heap space
  at eu.plumbr.demo.ArraySize.main<span class="o">(</span>ArraySize.java:8<span class="o">)</span>
java.lang.OutOfMemoryError: Requested array size exceeds VM limit
  at eu.plumbr.demo.ArraySize.main<span class="o">(</span>ArraySize.java:8<span class="o">)</span>
java.lang.OutOfMemoryError: Requested array size exceeds VM limit
  at eu.plumbr.demo.ArraySize.main<span class="o">(</span>ArraySize.java:8<span class="o">)</span>
</code></pre></div></div> <p>Note that before facing java.lang.OutOfMemoryError: Requested array size exceeds VM limit on the last two attempts, the allocations failed with a lot more familiar <code class="language-plaintext highlighter-rouge">java.lang.OutOfMemoryError: Java heap space</code> message. It happens because the 2^31-1 int primitives you are trying to make room for require 8G of memory which is less than the defaults used by the JVM.</p> <p>This example also demonstrates why the error is so rare – in order to see the VM limit on array size being hit, you need to allocate an array with the size right in between the platform limit and <code class="language-plaintext highlighter-rouge">Integer.MAX_INT</code>. When our example is run on 64bit Mac OS X with Hotspot 7, there are only two such array lengths: <code class="language-plaintext highlighter-rouge">Integer.MAX_INT-1</code> and <code class="language-plaintext highlighter-rouge">Integer.MAX_INT</code>.</p> <h3 id="what-is-the-solution">What is the solution?</h3> <p>The <code class="language-plaintext highlighter-rouge">java.lang.OutOfMemoryError: Requested array size exceeds VM limit</code> can appear as a result of either of the following situations:</p> <ul> <li>Your arrays grow too big and end up having a size between the platform limit and the <code class="language-plaintext highlighter-rouge">Integer.MAX_INT</code>.</li> <li>You deliberately try to allocate arrays larger than 2^31-1 elements to experiment with the limits.</li> </ul> <p>In the first case, check your code base to see whether you really need arrays that large. Maybe you could reduce the size of the arrays and be done with it. Or divide the array into smaller bulks and load the data you need to work with in batches fitting into your platform limit.</p> <p>In the second case – remember that Java arrays are indexed by int. So you cannot go beyond 2^31-1 elements in your arrays when using the standard data structures within the platform. In fact, in this case you are already blocked by the compiler announcing “<code class="language-plaintext highlighter-rouge">error: integer number too large</code>” during compilation.</p> <p>But if you really work with truly large data sets, you need to rethink your options. You can load the data you need to work with in smaller batches and still use standard Java tools, or you might go beyond the standard utilities. One way to achieve this is to look into the sun.misc.Unsafe class. This allows you to allocate memory directly like you would in C.</p> <div class="post-tags"> <nav class="nav-post-tags-list"> <ul class="tags"> <li><a href="/tag/java/">Java</a></li> <li><a href="/tag/oom/">OOM</a></li> <li><a href="/tag/jvm/">JVM</a></li> </ul> </nav> </div> </main> <footer> <hr class="footer-hr"> <div class="ui-flex"> <div class='wrapper-footer'> © 2023 Out of Memory.blog | <a href="mailto:yvens.fv@gmail.com">Yven Fong</a> </div> </div> </footer> </div> </body> </html>
